<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Character Award Generator ‚Äî Baymonte Christian School</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --gold: #d4af37; --gold-dim: rgba(212,175,55,0.25); --gold-faint: rgba(212,175,55,0.1);
  --navy: #0f1f3d; --navy-mid: #1a3060;
  --cream: #f5f0e8; --cream-dim: rgba(245,240,232,0.45);
  --red: #ef4444; --green: #22c55e;
}
body { min-height:100vh; background:linear-gradient(135deg,var(--navy) 0%,var(--navy-mid) 50%,var(--navy) 100%); font-family:Georgia,'Times New Roman',serif; color:var(--cream); }
.bg-grid { position:fixed;inset:0;pointer-events:none; background-image:repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(212,175,55,0.022) 40px,rgba(212,175,55,0.022) 41px),repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(212,175,55,0.022) 40px,rgba(212,175,55,0.022) 41px); }
.bg-glow { position:fixed;inset:0;pointer-events:none; background:radial-gradient(ellipse at 20% 50%,rgba(212,175,55,0.05) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(212,175,55,0.04) 0%,transparent 50%); }
.wrap { max-width:900px; margin:0 auto; padding:36px 20px 60px; position:relative; }
.header { text-align:center; margin-bottom:36px; }
.hr-gold { width:56px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:0 auto; }
.school-name { font-size:10px;letter-spacing:5px;color:var(--gold);text-transform:uppercase;margin:14px 0 10px; }
.main-title { font-size:clamp(22px,5vw,36px);font-weight:normal;letter-spacing:1px;margin-bottom:8px; }
.main-title span { color:var(--gold); }
.subtitle { color:var(--cream-dim);font-size:13px;font-style:italic; }
.card { background:rgba(255,255,255,0.03);border:1px solid rgba(212,175,55,0.17);border-radius:16px;padding:32px;backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.04); }
.progress { display:flex;align-items:center;justify-content:center;margin-bottom:32px; }
.step-dot { width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,255,255,0.11);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.28);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:bold;margin:0 auto 5px;transition:all 0.3s; }
.step-dot.active { background:linear-gradient(135deg,var(--gold),#b8962e);border-color:var(--gold);color:var(--navy); }
.step-label { font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.22);transition:color 0.3s; }
.step-label.active { color:var(--gold); }
.step-line { width:52px;height:1px;background:rgba(255,255,255,0.09);margin:0 6px 16px;transition:background 0.3s; }
.step-line.active { background:var(--gold); }
.field-label { display:block;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:10px; }
.field-label-row { display:flex;align-items:center;gap:10px;margin-bottom:10px; }
.field-label-row .field-label { margin-bottom:0; }
input[type=text],input[type=password],textarea { width:100%;padding:13px 16px;font-size:16px;background:rgba(255,255,255,0.06);border:1px solid var(--gold-dim);border-radius:8px;color:var(--cream);outline:none;font-family:Georgia,serif;transition:border-color 0.2s; }
input[type=text]:focus,input[type=password]:focus,textarea:focus { border-color:var(--gold); }
input::placeholder,textarea::placeholder { color:rgba(245,240,232,0.18); }
textarea { resize:vertical;line-height:1.75;font-size:14px; }
.btn-primary { width:100%;padding:15px;font-size:15px;font-weight:bold;background:linear-gradient(135deg,var(--gold),#b8962e);color:var(--navy);border:none;border-radius:8px;cursor:pointer;font-family:Georgia,serif;transition:opacity 0.2s;letter-spacing:0.3px; }
.btn-primary:disabled { background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.22);cursor:not-allowed; }
.btn-primary:not(:disabled):hover { opacity:0.9; }
.btn-ghost { padding:15px;font-size:13px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.09);color:rgba(245,240,232,0.5);border-radius:8px;cursor:pointer;font-family:Georgia,serif;transition:all 0.2s; }
.btn-ghost:hover { background:rgba(255,255,255,0.07);color:var(--cream-dim); }
.btn-back { background:none;border:1px solid rgba(255,255,255,0.11);color:rgba(255,255,255,0.32);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-family:Georgia,serif; }
.btn-row { display:flex;gap:10px; }
.btn-row .btn-primary { flex:2; }
.btn-row .btn-ghost { flex:1; }
.mic-box { border-radius:10px;border:1px solid var(--gold-dim);background:var(--gold-faint);padding:16px 20px;transition:all 0.3s; }
.mic-box.granted { border-color:rgba(34,197,94,0.35);background:rgba(34,197,94,0.05); }
.mic-box.denied { border-color:rgba(239,68,68,0.35);background:rgba(239,68,68,0.05); }
.mic-box.waiting { border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.07); }
.mic-box p { font-size:14px;margin:0; }
.mic-box p+p { margin-top:8px; }
.mic-box-row { display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap; }
.btn-mic { padding:9px 20px;border-radius:7px;border:1px solid rgba(212,175,55,0.4);background:rgba(212,175,55,0.12);color:var(--gold);cursor:pointer;font-family:Georgia,serif;font-size:13px;display:flex;align-items:center;gap:8px;white-space:nowrap;transition:all 0.2s; }
.btn-mic:hover { background:rgba(212,175,55,0.2); }
.rec-block { border:1px solid var(--gold-dim);border-radius:10px;overflow:hidden;transition:border-color 0.3s,box-shadow 0.3s;margin-bottom:14px; }
.rec-block.recording { border-color:rgba(239,68,68,0.45);box-shadow:0 0 22px rgba(239,68,68,0.12); }
.rec-header { display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:rgba(255,255,255,0.03);border-bottom:1px solid rgba(212,175,55,0.09);transition:background 0.3s; }
.rec-block.recording .rec-header { background:rgba(239,68,68,0.08); }
.rec-header-left { display:flex;align-items:center;gap:10px; }
.rec-label-input { background:none;border:none;outline:none;color:var(--cream);font-family:Georgia,serif;font-size:13px;font-weight:bold;width:140px;padding:0; }
.rec-wordcount { color:rgba(245,240,232,0.28);font-size:12px; }
.rec-header-right { display:flex;align-items:center;gap:8px; }
.pulse-dot { width:7px;height:7px;border-radius:50%;background:var(--red);animation:pulse 1s infinite; }
.rec-timer { color:var(--red);font-size:11px;letter-spacing:1.5px; }
.btn-record { display:flex;align-items:center;gap:6px;padding:7px 13px;border-radius:6px;border:none;cursor:pointer;font-family:Georgia,serif;font-size:12px;font-weight:bold;background:rgba(212,175,55,0.14);color:var(--gold);transition:all 0.2s; }
.btn-record.active { background:rgba(239,68,68,0.85);color:white; }
.btn-record:hover:not(.active) { background:rgba(212,175,55,0.25); }
.btn-remove { background:rgba(239,68,68,0.09);border:1px solid rgba(239,68,68,0.2);color:#fca5a5;border-radius:6px;padding:7px 8px;cursor:pointer;display:flex;align-items:center; }
.btn-add { width:100%;padding:10px;background:rgba(255,255,255,0.03);border:1px dashed rgba(212,175,55,0.22);color:rgba(212,175,55,0.55);border-radius:8px;cursor:pointer;font-family:Georgia,serif;font-size:13px;display:flex;align-items:center;justify-content:center;gap:7px;transition:all 0.2s;margin-bottom:14px; }
.btn-add:hover { border-color:rgba(212,175,55,0.5);color:var(--gold); }
.cert-box { background:rgba(245,240,232,0.022);border:1px solid rgba(212,175,55,0.24);border-radius:10px;padding:18px 22px;position:relative;margin-bottom:6px; }
.cert-line-top { position:absolute;top:9px;left:14px;right:14px;height:1px;background:linear-gradient(90deg,transparent,rgba(212,175,55,0.28),transparent); }
.cert-line-bot { position:absolute;bottom:9px;left:14px;right:14px;height:1px;background:linear-gradient(90deg,transparent,rgba(212,175,55,0.28),transparent); }
.cert-box textarea { background:none;border:none;outline:none;font-size:15px;line-height:1.9;padding:0; }
.wc-badge { display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:10px; }
.wc-good { background:rgba(34,197,94,0.11);color:#86efac;border:1px solid rgba(34,197,94,0.25); }
.wc-bad { background:rgba(245,158,11,0.11);color:#fcd34d;border:1px solid rgba(245,158,11,0.25); }
.ai-badge { padding:2px 9px;border-radius:4px;background:rgba(212,175,55,0.11);border:1px solid rgba(212,175,55,0.24);color:var(--gold);font-size:11px; }
.pill { display:inline-flex;align-items:center;gap:5px;padding:4px 11px;border-radius:20px;font-size:12px;font-weight:bold;letter-spacing:0.3px;white-space:nowrap; }
.pill-none { background:rgba(255,255,255,0.06);color:rgba(245,240,232,0.45);border:1px solid rgba(255,255,255,0.1); }
.pill-prog { background:rgba(212,175,55,0.12);color:var(--gold);border:1px solid rgba(212,175,55,0.3); }
.pill-done { background:rgba(34,197,94,0.12);color:#86efac;border:1px solid rgba(34,197,94,0.3); }
.classes-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-bottom:24px; }
.class-card { background:rgba(255,255,255,0.03);border:1px solid rgba(212,175,55,0.17);border-radius:12px;padding:22px;cursor:pointer;transition:all 0.2s;position:relative; }
.class-card:hover { background:rgba(255,255,255,0.055);border-color:rgba(212,175,55,0.35);transform:translateY(-2px); }
.class-card-name { font-size:17px;font-weight:normal;color:var(--cream);margin-bottom:6px; }
.class-card-sub { font-size:12px;color:rgba(245,240,232,0.38);font-style:italic;margin-bottom:14px; }
.class-card-progress { height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;margin-bottom:10px; }
.class-card-bar { height:100%;background:linear-gradient(90deg,var(--gold),#b8962e);border-radius:2px;transition:width 0.4s; }
.class-card-stats { display:flex;gap:10px;flex-wrap:wrap; }
.class-card-stat { font-size:11px;color:rgba(245,240,232,0.4); }
.class-card-stat span { color:var(--cream);font-weight:bold; }
.class-card-delete { position:absolute;top:12px;right:12px;background:none;border:none;color:rgba(245,240,232,0.2);cursor:pointer;font-size:16px;line-height:1;padding:4px;border-radius:4px;transition:all 0.2s; }
.class-card-delete:hover { color:#fca5a5;background:rgba(239,68,68,0.1); }
.roster-header { display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px; }
.roster-stats { display:flex;gap:10px;flex-wrap:wrap; }
.stat-chip { font-size:12px;color:rgba(245,240,232,0.45);padding:4px 12px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08); }
.stat-chip span { color:var(--cream);font-weight:bold; }
.roster-table { width:100%;border-collapse:collapse;margin-bottom:20px; }
.roster-table th { font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--gold);padding:10px 16px;text-align:left;border-bottom:1px solid rgba(212,175,55,0.2); }
.roster-table td { padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:middle; }
.roster-table tr:last-child td { border-bottom:none; }
.roster-table tr:hover td { background:rgba(255,255,255,0.025); }
.student-btn { background:none;border:none;cursor:pointer;font-family:Georgia,serif;font-size:15px;color:var(--cream);text-align:left;padding:0;transition:color 0.2s;display:flex;align-items:center;gap:8px; }
.student-btn:hover { color:var(--gold); }
.student-btn .arrow { color:var(--gold);opacity:0;transition:opacity 0.2s;font-size:13px; }
.roster-table tr:hover .arrow { opacity:1; }
.notes-cell { font-size:12px;color:rgba(245,240,232,0.35);font-style:italic;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }
.paste-area { background:rgba(255,255,255,0.03);border:1px dashed rgba(212,175,55,0.25);border-radius:10px;padding:20px; }
.paste-area textarea { background:rgba(0,0,0,0.2);border:1px solid rgba(212,175,55,0.2);border-radius:8px;padding:12px 14px;font-size:13px;height:130px;margin-bottom:14px; }
.spinner-wrap { text-align:center;padding:50px 0; }
.spinner { width:56px;height:56px;margin:0 auto 22px;border:3px solid rgba(212,175,55,0.13);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite; }
.error-box { background:rgba(239,68,68,0.09);border:1px solid rgba(239,68,68,0.28);border-radius:8px;padding:11px 15px;color:#fca5a5;font-size:14px;margin-bottom:14px; }
.meta-row { display:flex;justify-content:space-between;align-items:center;margin-bottom:22px; }
.meta-info { font-size:13px;color:var(--cream-dim);font-style:italic; }
.hint { color:rgba(245,240,232,0.27);font-size:12px;font-style:italic;text-align:right;margin-top:6px;margin-bottom:22px; }
.restore-btn { background:none;border:none;color:rgba(212,175,55,0.5);font-size:12px;cursor:pointer;font-style:italic;padding:0;font-family:Georgia,serif;margin-top:7px; }
.restore-btn:hover { color:var(--gold); }
.footer { text-align:center;color:rgba(245,240,232,0.16);font-size:12px;margin-top:26px;font-style:italic; }
.mb-18 { margin-bottom:18px; } .mb-26 { margin-bottom:26px; }
.total-words { text-align:right;color:rgba(245,240,232,0.3);font-size:13px;margin-bottom:14px; }
.green-dot { width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0; }
.sec-title { font-size:19px;font-weight:normal;color:var(--cream);margin-bottom:22px; }
.draft-badge { display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--gold);background:rgba(212,175,55,0.1);border:1px solid rgba(212,175,55,0.25);border-radius:4px;padding:1px 7px;margin-left:7px; }
.btn-save-draft { width:100%;padding:11px;background:rgba(212,175,55,0.07);border:1px solid rgba(212,175,55,0.22);color:rgba(212,175,55,0.7);border-radius:8px;cursor:pointer;font-family:Georgia,serif;font-size:13px;margin-bottom:10px;transition:all 0.2s; }
.btn-save-draft:hover { background:rgba(212,175,55,0.13);color:var(--gold); }
.modal-bg { position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px); }
.modal { background:#1a2d52;border:1px solid rgba(212,175,55,0.25);border-radius:14px;padding:32px;max-width:480px;width:90%;box-shadow:0 30px 80px rgba(0,0,0,0.5); }
.modal h3 { font-size:18px;font-weight:normal;margin-bottom:18px;color:var(--cream); }
.modal-btns { display:flex;gap:10px;margin-top:20px; }
.modal-btns .btn-primary,.modal-btns .btn-ghost { flex:1; }
.sync-indicator { position:fixed;bottom:20px;right:20px;padding:8px 16px;border-radius:20px;font-size:12px;font-family:Georgia,serif;transition:all 0.3s;pointer-events:none; }
.sync-saving { background:rgba(212,175,55,0.15);border:1px solid rgba(212,175,55,0.3);color:var(--gold); }
.sync-saved { background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#86efac; }
.sync-error { background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#fca5a5; }
@keyframes spin { to{transform:rotate(360deg);} }
@keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.2;} }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);} }
.fade-in { animation:fadeIn 0.2s ease; }
::-webkit-scrollbar{width:5px;} ::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);} ::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.22);border-radius:3px;}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow"></div>
<div class="sync-indicator" id="syncIndicator" style="display:none"></div>

<div class="wrap">
  <div class="header">
    <div class="hr-gold"></div>
    <div class="school-name">Baymonte Christian School</div>
    <h1 class="main-title">Character Award <span>Generator</span></h1>
    <p class="subtitle">Shared roster ¬∑ Faculty discussion recording ¬∑ Award text generation</p>
    <div class="hr-gold" style="margin-top:14px"></div>
  </div>

  <!-- LOGIN -->
  <div id="view-login" style="display:none">
    <div class="card fade-in" style="max-width:420px;margin:0 auto">
      <h2 class="sec-title" style="text-align:center;margin-bottom:8px">Welcome</h2>
      <p style="text-align:center;color:var(--cream-dim);font-size:14px;font-style:italic;margin-bottom:28px">Baymonte Christian School</p>
      <div class="mb-26">
        <label class="field-label">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter app password"
          onkeydown="if(event.key==='Enter')doLogin()" oninput="document.getElementById('loginError').style.display='none'">
        <div class="error-box" id="loginError" style="display:none;margin-top:10px;margin-bottom:0">Incorrect password. Please try again.</div>
      </div>
      <button class="btn-primary" onclick="doLogin()">Enter ‚Üí</button>
    </div>
  </div>

  <!-- CLASSES -->
  <div id="view-classes" style="display:none">
    <div class="card fade-in">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
        <h2 class="sec-title" style="margin-bottom:0">My Classes</h2>
        <button class="btn-ghost" style="padding:8px 16px;font-size:12px" onclick="openSettings()">‚öô Settings</button>
      </div>
      <div class="classes-grid" id="classesGrid"></div>
      <div id="addClassBtn" style="text-align:center">
        <button onclick="openNewClass()" style="padding:12px 28px;background:rgba(212,175,55,0.08);border:1px dashed rgba(212,175,55,0.3);color:rgba(212,175,55,0.7);border-radius:8px;cursor:pointer;font-family:Georgia,serif;font-size:14px;transition:all 0.2s"
          onmouseover="this.style.borderColor='rgba(212,175,55,0.6)';this.style.color='var(--gold)'"
          onmouseout="this.style.borderColor='rgba(212,175,55,0.3)';this.style.color='rgba(212,175,55,0.7)'">+ Add Class</button>
      </div>
    </div>
  </div>

  <!-- ROSTER -->
  <div id="view-roster" style="display:none">
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <button class="btn-back" onclick="showView('classes')">‚Üê All Classes</button>
      <span style="color:rgba(245,240,232,0.3);font-size:13px;font-style:italic" id="rosterBreadcrumb"></span>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn-ghost" style="padding:7px 14px;font-size:12px" onclick="openEditClass()">‚úè Edit Class</button>
      </div>
    </div>
    <div class="card fade-in">
      <div class="roster-header">
        <div>
          <h2 class="sec-title" style="margin-bottom:6px" id="rosterClassName"></h2>
          <div class="roster-stats" id="rosterStats"></div>
        </div>
      </div>
      <div style="height:6px;background:rgba(255,255,255,0.06);border-radius:3px;margin-bottom:22px;overflow:hidden">
        <div id="rosterProgressBar" style="height:100%;background:linear-gradient(90deg,var(--gold),#b8962e);border-radius:3px;transition:width 0.4s;width:0%"></div>
      </div>
      <table class="roster-table">
        <thead><tr>
          <th style="width:42%">Student</th>
          <th style="width:20%">Status</th>
          <th>Award Title</th>
        </tr></thead>
        <tbody id="rosterBody"></tbody>
      </table>
    </div>
  </div>

  <!-- GENERATOR -->
  <div id="view-generator" style="display:none">
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px">
      <button class="btn-back" onclick="goRoster()">‚Üê Roster</button>
      <span style="color:rgba(245,240,232,0.3);font-size:13px;font-style:italic" id="genBreadcrumb"></span>
    </div>
    <div class="progress" id="progress">
      <div style="text-align:center"><div class="step-dot active" id="dot0">1</div><div class="step-label active" id="lbl0">Student</div></div>
      <div class="step-line" id="line0"></div>
      <div style="text-align:center"><div class="step-dot" id="dot1">2</div><div class="step-label" id="lbl1">Discussion</div></div>
      <div class="step-line" id="line1"></div>
      <div style="text-align:center"><div class="step-dot" id="dot2">3</div><div class="step-label" id="lbl2">Award</div></div>
    </div>
    <div class="card">
      <div id="step-input">
        <h2 class="sec-title">Student Information</h2>
        <div class="mb-26">
          <label class="field-label">Student Name</label>
          <input type="text" id="studentName" placeholder="e.g., Ava Aldana" oninput="updateContinueBtn()">
        </div>
        <button class="btn-primary" id="btnContinue" onclick="goDiscussion()" disabled>Continue ‚Üí</button>
      </div>
      <div id="step-discussion" style="display:none">
        <div class="meta-row">
          <div>
            <h2 class="sec-title" style="margin-bottom:3px">Faculty Discussion</h2>
            <p class="meta-info">For: <span id="nameDisplay" style="color:var(--gold)"></span></p>
          </div>
          <button class="btn-back" onclick="genStep('input')">‚Üê Back</button>
        </div>
        <div id="recordingsContainer"></div>
        <button class="btn-add" id="btnAddRec" onclick="addRecording()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Another Recording <span id="recCount" style="opacity:0.5">(1/4)</span>
        </button>
        <div class="total-words">Total: <span id="totalWords" style="color:rgba(212,175,55,0.7)">0</span> words</div>
        <div class="error-box" id="discError" style="display:none"></div>
        <button class="btn-save-draft" onclick="saveDraft()">üíæ Save Draft &amp; Return to Roster</button>
        <button class="btn-primary" id="btnGenerate" onclick="generateAward()" disabled>Generate Award Text ‚ú®</button>
      </div>
      <div id="step-processing" style="display:none">
        <div class="spinner-wrap">
          <div class="spinner"></div>
          <h2 style="font-weight:normal;font-size:20px;margin-bottom:10px">Crafting Award Text</h2>
          <p style="color:rgba(245,240,232,0.38);font-style:italic;font-size:14px" id="processingMsg"></p>
        </div>
      </div>
      <div id="step-result" style="display:none">
        <div class="meta-row">
          <div><h2 class="sec-title" style="margin-bottom:4px">Award Ready</h2>
          <p class="meta-info" id="resultMeta"></p></div>
        </div>
        <div class="mb-18">
          <div class="field-label-row">
            <span class="field-label">Award Title</span>
            <span class="ai-badge">‚ú¶ AI Proposed</span>
          </div>
          <input type="text" id="awardTitle" placeholder="Award title‚Ä¶">
          <button class="restore-btn" id="restoreBtn" style="display:none" onclick="restoreTitle()"></button>
        </div>
        <div class="mb-18">
          <label class="field-label">Award Description</label>
          <div class="cert-box">
            <div class="cert-line-top"></div><div class="cert-line-bot"></div>
            <textarea id="awardText" rows="10"></textarea>
          </div>
        </div>
        <p class="hint">Editable ‚Äî revise freely before copying</p>
        <div class="btn-row" style="margin-bottom:10px">
          <button class="btn-primary" id="btnCopy" onclick="copyAward()">Copy to Clipboard</button>
          <button class="btn-ghost" onclick="regenerate()">Regenerate</button>
          <button class="btn-ghost" onclick="regenerate()">Edit Discussion</button>
        </div>
        <button onclick="markComplete()"
          style="width:100%;padding:13px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:#86efac;border-radius:8px;cursor:pointer;font-family:Georgia,serif;font-size:14px;font-weight:bold;transition:all 0.2s"
          onmouseover="this.style.background='rgba(34,197,94,0.18)'" onmouseout="this.style.background='rgba(34,197,94,0.1)'">
          ‚úì Approve &amp; Mark Complete ‚Äî Return to Roster
        </button>
      </div>
    </div>
  </div>

  <p class="footer">A good name is more desirable than great riches ‚Äî Proverbs 22:1</p>
</div>

<!-- CLASS MODAL -->
<div class="modal-bg" id="classModal" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h3 id="classModalTitle">Add New Class</h3>
    <div class="mb-18">
      <label class="field-label">Class Name *</label>
      <input type="text" id="modalClassName" placeholder="e.g., Grade 7 ‚Äî Mr. Rivera" oninput="updateModalBtn()">
    </div>
    <div class="mb-18">
      <label class="field-label">Student Roster</label>
      <div class="paste-area" style="padding:16px">
        <p style="color:var(--cream-dim);font-size:12px;margin-bottom:10px;font-style:italic">One name per line. Existing students won't be overwritten.</p>
        <textarea id="modalRosterPaste" placeholder="Jane Smith&#10;John Doe&#10;‚Ä¶" style="height:110px;margin-bottom:0"></textarea>
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-primary" id="btnModalSave" onclick="saveClassModal()" disabled>Save Class</button>
      <button class="btn-ghost" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-bg" id="settingsModal" style="display:none" onclick="if(event.target===this)closeSettingsModal()">
  <div class="modal">
    <h3>Settings</h3>
    <div class="mb-18">
      <label class="field-label">Microphone</label>
      <div class="mic-box" id="settingsMicBox">
        <div class="mic-box-row">
          <p style="color:var(--cream-dim)">Enable voice recording for faculty discussions.</p>
          <button class="btn-mic" onclick="requestMic()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
            Enable Microphone
          </button>
        </div>
      </div>
    </div>
    <p style="color:rgba(245,240,232,0.3);font-size:12px;font-style:italic">
      App version: <span id="appVersion">‚Äî</span> ¬∑ Data synced to cloud
    </p>
    <div class="modal-btns">
      <button class="btn-ghost" onclick="closeSettingsModal()" style="width:100%">Close</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî filled in by deploy script
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL  = "REPLACE_SUPABASE_URL";
const SUPABASE_ANON = "REPLACE_SUPABASE_ANON_KEY";
const APP_VERSION   = "1.0.0";

const SYSTEM_PROMPT = `You are an assistant helping a Christian school (Baymonte Christian School) write character award descriptions for students.

Given one or more faculty discussion transcripts about a student, extract key accolades, specific anecdotes, and character traits. Return a JSON object with exactly two fields:
- "title": A short award title of 1-3 words capturing the student's most distinctive character trait(s). Examples: "Loyalty", "Compassion", "Wise Leadership", "Joy and Kindness". Keep it concise and meaningful.
- "text": A polished award description that:
  * Is between 100-150 words
  * Highlights 1-2 specific character qualities with concrete examples or anecdotes from the transcripts
  * Uses warm, affirming language appropriate for a school award certificate
  * Avoids generic filler; every sentence should be meaningful
  * Includes a relevant Bible verse that naturally reinforces the character trait(s) highlighted
  * Is written in third person (e.g., "Ava is..." not "You are...")
  * Ends on an encouraging, forward-looking note

Return ONLY valid JSON. No markdown, no code fences, no extra text.`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE CLIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let appPassword = "";  // entered at login, kept in memory only
let classes = [];
let micStatus = "unknown";
let currentClassId = null;
let currentStudentId = null;
let isEditingClass = false;
let recordings = [];
let recNextId = 1;
let activeRecId = null;
let recognitionObj = null;
let timerInterval = null;
let timerSecs = 0;
let finalTx = "";
let interimTx = "";
let proposedTitle = "";

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SR) micStatus = "unsupported";

document.getElementById("appVersion").textContent = APP_VERSION;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doLogin() {
  const pw = document.getElementById("loginPassword").value;
  // Verify by attempting a Supabase read ‚Äî if the password is wrong
  // the serverless function will reject it; we do a lightweight test call.
  // Actually we just store the password and verify it on first API call.
  // For the roster data we use Supabase directly (public read with anon key).
  // The password is only checked by the generate function.
  appPassword = pw;
  sessionStorage.setItem("bcs_pw", pw);
  await loadClasses();
  showView("classes");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showSync(state, msg) {
  const el = document.getElementById("syncIndicator");
  el.className = "sync-indicator sync-" + state;
  el.textContent = msg;
  el.style.display = "";
  if (state === "saved") setTimeout(() => el.style.display = "none", 2000);
}

async function loadClasses() {
  const { data, error } = await sb.from("classes").select("*").order("created_at");
  if (error) { console.error(error); return; }
  // Load students for each class
  const { data: students } = await sb.from("students").select("*").order("name");
  classes = (data || []).map(cls => ({
    ...cls,
    students: (students || []).filter(s => s.class_id === cls.id)
  }));
}

async function saveClass(cls) {
  showSync("saving", "Saving‚Ä¶");
  const { error } = await sb.from("classes").upsert({ id: cls.id, name: cls.name });
  if (error) { showSync("error", "Save failed"); console.error(error); return; }
  showSync("saved", "‚úì Saved");
}

async function saveStudent(student) {
  showSync("saving", "Saving‚Ä¶");
  const row = {
    id: student.id,
    class_id: student.class_id,
    name: student.name,
    status: student.status,
    award_title: student.awardTitle || "",
    award_text: student.awardText || "",
    recordings: student.recordings || []
  };
  const { error } = await sb.from("students").upsert(row);
  if (error) { showSync("error", "Save failed"); console.error(error); return; }
  showSync("saved", "‚úì Saved");
  // Refresh local copy
  const cls = classes.find(c => String(c.id) === String(student.class_id));
  if (cls) {
    const idx = cls.students.findIndex(s => String(s.id) === String(student.id));
    if (idx >= 0) cls.students[idx] = { ...student };
    else cls.students.push({ ...student });
  }
}

async function deleteClassFromDB(id) {
  await sb.from("students").delete().eq("class_id", id);
  await sb.from("classes").delete().eq("id", id);
}

async function deleteStudentFromDB(id) {
  await sb.from("students").delete().eq("id", id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW ROUTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showView(v) {
  ["login","classes","roster","generator"].forEach(n =>
    document.getElementById("view-"+n).style.display = (n===v) ? "" : "none"
  );
  if (v === "classes") renderClassesGrid();
  if (v === "roster") renderRoster();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSettings() {
  renderMicBox("settingsMicBox");
  document.getElementById("settingsModal").style.display = "flex";
}
function closeSettingsModal() { document.getElementById("settingsModal").style.display = "none"; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLASS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNewClass() {
  if (classes.length >= 4) { alert("Maximum 4 classes reached. Delete a class to add another."); return; }
  isEditingClass = false;
  document.getElementById("classModalTitle").textContent = "Add New Class";
  document.getElementById("modalClassName").value = "";
  document.getElementById("modalRosterPaste").value = "";
  document.getElementById("btnModalSave").textContent = "Save Class";
  updateModalBtn();
  document.getElementById("classModal").style.display = "flex";
}

function openEditClass() {
  isEditingClass = true;
  const cls = classes.find(c => String(c.id) === String(currentClassId));
  if (!cls) return;
  document.getElementById("classModalTitle").textContent = "Edit Class";
  document.getElementById("modalClassName").value = cls.name;
  document.getElementById("modalRosterPaste").value = "";
  document.getElementById("btnModalSave").textContent = "Update Class";
  updateModalBtn();
  document.getElementById("classModal").style.display = "flex";
}

function updateModalBtn() {
  document.getElementById("btnModalSave").disabled = !document.getElementById("modalClassName").value.trim();
}

async function saveClassModal() {
  const name = document.getElementById("modalClassName").value.trim();
  const raw  = document.getElementById("modalRosterPaste").value;
  if (!name) return;

  if (isEditingClass) {
    const cls = classes.find(c => String(c.id) === String(currentClassId));
    if (cls) {
      cls.name = name;
      await saveClass(cls);
      // Add new students
      const newStudents = parseRosterNames(raw, cls.students);
      for (const s of newStudents) {
        s.class_id = cls.id;
        await saveStudent(s);
      }
      await loadClasses();
    }
  } else {
    const newId = crypto.randomUUID();
    const cls = { id: newId, name, students: [] };
    classes.push(cls);
    await saveClass(cls);
    const newStudents = parseRosterNames(raw, []);
    for (const s of newStudents) {
      s.class_id = newId;
      await saveStudent(s);
    }
    await loadClasses();
  }
  closeModal();
  showView(isEditingClass ? "roster" : "classes");
}

function closeModal() { document.getElementById("classModal").style.display = "none"; }

async function deleteClass(id) {
  const cls = classes.find(c => String(c.id) === String(id));
  if (!cls) return;
  if (!confirm(`Delete "${cls.name}" and all its student data? This cannot be undone.`)) return;
  await deleteClassFromDB(id);
  classes = classes.filter(c => String(c.id) !== String(id));
  renderClassesGrid();
}

function parseRosterNames(raw, existing) {
  const existingNames = new Set(existing.map(s => s.name.toLowerCase()));
  return raw.split("\n").map(s => s.trim()).filter(Boolean)
    .filter(name => !existingNames.has(name.toLowerCase()))
    .map(name => ({
      id: crypto.randomUUID(), name,
      status: "none", awardTitle: "", awardText: "", recordings: []
    }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLASSES GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderClassesGrid() {
  const grid = document.getElementById("classesGrid");
  grid.innerHTML = "";
  classes.forEach(cls => {
    const total = cls.students.length;
    const done  = cls.students.filter(s => s.status === "done").length;
    const prog  = cls.students.filter(s => s.status === "prog").length;
    const pct   = total ? Math.round(done/total*100) : 0;
    const div   = document.createElement("div");
    div.className = "class-card fade-in";
    div.onclick = e => { if (!e.target.closest(".class-card-delete")) openClass(cls.id); };
    div.innerHTML = `
      <button class="class-card-delete" onclick="deleteClass('${cls.id}')" title="Delete">‚úï</button>
      <div class="class-card-name">${escHtml(cls.name)}</div>
      <div class="class-card-sub">${total} student${total!==1?"s":""}</div>
      <div class="class-card-progress"><div class="class-card-bar" style="width:${pct}%"></div></div>
      <div class="class-card-stats">
        <span class="class-card-stat"><span>${done}</span> complete</span>
        <span class="class-card-stat"><span>${prog}</span> in progress</span>
        <span class="class-card-stat"><span>${total-done-prog}</span> not started</span>
      </div>`;
    grid.appendChild(div);
  });
  document.getElementById("addClassBtn").style.display = classes.length < 4 ? "" : "none";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROSTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openClass(id) {
  currentClassId = id;
  const cls = classes.find(c => String(c.id) === String(id));
  if (!cls) return;
  document.getElementById("rosterBreadcrumb").textContent = cls.name;
  document.getElementById("rosterClassName").textContent = cls.name;
  showView("roster");
}

function renderRoster() {
  const cls = classes.find(c => String(c.id) === String(currentClassId));
  if (!cls) return;
  const tbody = document.getElementById("rosterBody");
  tbody.innerHTML = "";
  cls.students.forEach(s => {
    const hasDraft = s.recordings && s.recordings.some(r => r.transcript && r.transcript.trim());
    const draftBadge = (s.status==="prog" && hasDraft) ? `<span class="draft-badge">üíæ draft</span>` : "";
    const pill = { none:`<span class="pill pill-none">Not Started</span>`, prog:`<span class="pill pill-prog">‚è≥ In Progress</span>`, done:`<span class="pill pill-done">‚úì Complete</span>` }[s.status] || `<span class="pill pill-none">Not Started</span>`;
    const note = s.award_title ? `<em style="color:var(--gold);opacity:0.85">${escHtml(s.award_title)}</em>` : `<span style="opacity:0.2">‚Äî</span>`;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><button class="student-btn" onclick="openStudent('${s.id}')"><span class="arrow">‚Üí</span>${escHtml(s.name)}${draftBadge}</button></td><td>${pill}</td><td class="notes-cell">${note}</td>`;
    tbody.appendChild(tr);
  });
  const total = cls.students.length, done = cls.students.filter(s=>s.status==="done").length, prog = cls.students.filter(s=>s.status==="prog").length;
  const pct = total ? Math.round(done/total*100) : 0;
  document.getElementById("rosterStats").innerHTML = `<span class="stat-chip"><span>${total}</span> students</span><span class="stat-chip"><span>${done}</span> complete</span><span class="stat-chip"><span>${prog}</span> in progress</span><span class="stat-chip"><span>${total-done-prog}</span> not started</span>`;
  document.getElementById("rosterProgressBar").style.width = pct + "%";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OPEN STUDENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openStudent(sid) {
  const cls = classes.find(c => String(c.id) === String(currentClassId));
  if (!cls) return;
  const student = cls.students.find(s => String(s.id) === String(sid));
  if (!student) return;
  currentStudentId = student.id;

  recordings = student.recordings && student.recordings.length
    ? student.recordings.map(r => ({...r}))
    : [{ id:1, label:"Recording 1", transcript:"", words:0 }];
  recNextId = Math.max(...recordings.map(r=>r.id)) + 1;
  proposedTitle = student.award_title || "";
  activeRecId = null;

  document.getElementById("studentName").value = student.name;
  document.getElementById("genBreadcrumb").textContent = `${cls.name} ¬∑ ${student.name}`;
  updateContinueBtn();

  if (student.award_text) {
    document.getElementById("nameDisplay").textContent = student.name;
    showView("generator"); genStep("result");
    document.getElementById("awardTitle").value = student.award_title || "";
    document.getElementById("awardText").value = student.award_text;
    updateResultMeta(student.name, student.award_text);
    document.getElementById("restoreBtn").style.display = "none";
  } else if (student.status === "prog") {
    document.getElementById("nameDisplay").textContent = student.name;
    showView("generator"); genStep("discussion"); renderRecordings();
  } else {
    showView("generator"); genStep("input");
  }
}

function goRoster() { if (activeRecId!==null) stopRecording(); showView("roster"); }

function currentStudent() {
  const cls = classes.find(c=>String(c.id)===String(currentClassId));
  return cls ? cls.students.find(s=>String(s.id)===String(currentStudentId)) : null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEN STEPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genStep(name) {
  ["input","discussion","processing","result"].forEach(s =>
    document.getElementById("step-"+s).style.display = (s===name)?"":"none"
  );
  const idx = {input:0,discussion:1,processing:2,result:2}[name];
  for (let i=0;i<3;i++) {
    const active=idx>=i, past=idx>i;
    document.getElementById("dot"+i).className="step-dot"+(active?" active":"");
    document.getElementById("dot"+i).textContent=past?"‚úì":(i+1);
    document.getElementById("lbl"+i).className="step-label"+(active?" active":"");
    if(i<2) document.getElementById("line"+i).className="step-line"+(past?" active":"");
  }
}
function updateContinueBtn() { document.getElementById("btnContinue").disabled=!document.getElementById("studentName").value.trim(); }
function goDiscussion() { const n=document.getElementById("studentName").value.trim(); if(!n)return; document.getElementById("nameDisplay").textContent=n; genStep("discussion"); renderRecordings(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE DRAFT & COMPLETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveDraft() {
  if (activeRecId!==null) stopRecording();
  const s = currentStudent();
  if (s) {
    s.recordings = recordings.map(r=>({...r}));
    s.status = "prog";
    s.class_id = currentClassId;
    await saveStudent(s);
  }
  showView("roster");
}

async function markComplete() {
  const s = currentStudent();
  if (s) {
    s.status = "done";
    s.award_title = document.getElementById("awardTitle").value.trim();
    s.award_text  = document.getElementById("awardText").value.trim();
    s.awardTitle  = s.award_title;
    s.class_id    = currentClassId;
    await saveStudent(s);
  }
  showView("roster");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECORDINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addRecording() {
  if(recordings.length>=4)return;
  recordings.push({id:recNextId++,label:`Recording ${recordings.length+1}`,transcript:"",words:0});
  renderRecordings();
}
function removeRecording(id) { if(recordings.length<=1)return; if(activeRecId===id)stopRecording(); recordings=recordings.filter(r=>r.id!==id); renderRecordings(); }
function updateTranscript(id,val) { const r=recordings.find(r=>r.id===id); if(r){r.transcript=val;r.words=val.trim().split(/\s+/).filter(Boolean).length;} updateTotalWords();updateGenerateBtn(); }
function updateTotalWords() { document.getElementById("totalWords").textContent=recordings.reduce((s,r)=>s+r.words,0); }
function updateGenerateBtn() { document.getElementById("btnGenerate").disabled=!recordings.some(r=>r.transcript.trim()); }

const micSVG=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>`;
const stopSVG=`<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>`;
const trashSVG=`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>`;

function renderRecordings() {
  const container=document.getElementById("recordingsContainer"); container.innerHTML="";
  recordings.forEach(rec=>{
    const isActive=activeRecId===rec.id;
    const div=document.createElement("div"); div.className="rec-block"+(isActive?" recording":""); div.id=`rec-${rec.id}`;
    const timerHtml=isActive?`<div class="pulse-dot"></div><span class="rec-timer" id="timer-${rec.id}">00:00</span>`:"";
    const recBtnHtml=micStatus==="granted"
      ?`<button class="btn-record${isActive?" active":""}" onclick="${isActive?`stopRecording()`:`startRecording(${rec.id})`}">${isActive?stopSVG+" Stop":micSVG+" Record"}</button>`
      :`<span style="color:rgba(255,255,255,0.22);font-size:12px;font-style:italic">${micStatus==="unknown"?"open Settings to enable mic":"type below"}</span>`;
    const removeBtnHtml=recordings.length>1?`<button class="btn-remove" onclick="removeRecording(${rec.id})">${trashSVG}</button>`:"";
    div.innerHTML=`<div class="rec-header"><div class="rec-header-left">${timerHtml}<input class="rec-label-input" type="text" value="${escHtml(rec.label)}" oninput="recordings.find(r=>r.id===${rec.id}).label=this.value"><span class="rec-wordcount">${rec.words}w</span></div><div class="rec-header-right">${recBtnHtml}${removeBtnHtml}</div></div><textarea rows="6" style="padding:13px 15px;background:rgba(0,0,0,0.14);border:none;outline:none;display:block;width:100%;font-size:14px;color:var(--cream);font-family:Georgia,serif;" placeholder="Transcript appears here as you speak, or type / paste notes‚Ä¶" oninput="updateTranscript(${rec.id},this.value)">${escHtml(rec.transcript)}</textarea>`;
    container.appendChild(div);
  });
  const btnAdd=document.getElementById("btnAddRec");
  if(recordings.length>=4)btnAdd.style.display="none";
  else{btnAdd.style.display="flex";document.getElementById("recCount").textContent=`(${recordings.length}/4)`;}
  updateTotalWords();updateGenerateBtn();
  if(activeRecId!==null)startVisualTimer();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPEECH RECOGNITION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startRecording(id) {
  if(!SR||micStatus!=="granted"||activeRecId!==null)return;
  const rec=recordings.find(r=>r.id===id); finalTx=rec.transcript||"";interimTx="";
  const recognition=new SR(); recognition.continuous=true;recognition.interimResults=true;recognition.lang="en-US";
  recognition.onstart=()=>{activeRecId=id;renderRecordings();};
  recognition.onresult=(event)=>{let interim="";for(let i=event.resultIndex;i<event.results.length;i++){if(event.results[i].isFinal)finalTx+=event.results[i][0].transcript+" ";else interim+=event.results[i][0].transcript;}interimTx=interim;updateTranscriptLive(id,(finalTx+interim).trim());};
  recognition.onerror=(e)=>{if(e.error==="not-allowed"){setMicStatus("denied");stopRecording();}};
  recognition.onend=()=>{if(interimTx.trim()){finalTx+=interimTx+" ";interimTx="";}updateTranscriptLive(id,finalTx.trim());if(activeRecId===id&&recognitionObj===recognition){setTimeout(()=>{if(activeRecId===id&&recognitionObj===recognition){try{recognition.start();}catch(e){}}},100);}};
  recognitionObj=recognition;
  let lastActivity=Date.now();const origOnResult=recognition.onresult;recognition.onresult=(event)=>{lastActivity=Date.now();origOnResult(event);};
  const watchdog=setInterval(()=>{if(activeRecId!==id||recognitionObj!==recognition){clearInterval(watchdog);return;}if(Date.now()-lastActivity>7000){lastActivity=Date.now();try{recognition.stop();}catch(e){}}},2000);
  recognition.start();
}

function stopRecording(){if(recognitionObj){try{recognitionObj.stop();}catch{}recognitionObj=null;}activeRecId=null;clearInterval(timerInterval);timerInterval=null;timerSecs=0;renderRecordings();}
function startVisualTimer(){clearInterval(timerInterval);timerSecs=0;timerInterval=setInterval(()=>{timerSecs++;const el=document.getElementById(`timer-${activeRecId}`);if(el){const m=String(Math.floor(timerSecs/60)).padStart(2,"0"),s=String(timerSecs%60).padStart(2,"0");el.textContent=`${m}:${s}`;}},1000);}
function updateTranscriptLive(id,val){const r=recordings.find(r=>r.id===id);if(r){r.transcript=val;r.words=val.split(/\s+/).filter(Boolean).length;}const block=document.getElementById(`rec-${id}`);if(block){const ta=block.querySelector("textarea");if(ta&&document.activeElement!==ta)ta.value=val;const wc=block.querySelector(".rec-wordcount");if(wc)wc.textContent=r.words+"w";}updateTotalWords();updateGenerateBtn();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMicBox(boxId) {
  const box=document.getElementById(boxId); if(!box)return;
  const s=micStatus;
  box.className="mic-box"+(s==="granted"?" granted":s==="denied"?" denied":s==="requesting"?" waiting":"");
  const btn=`<button class="btn-mic" onclick="requestMic()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg> Enable Microphone</button>`;
  if(s==="unsupported")box.innerHTML=`<p style="color:#fcd34d">‚ö† Voice recording not supported in this browser.</p>`;
  else if(s==="unknown")box.innerHTML=`<div class="mic-box-row"><p style="color:var(--cream-dim)">Enable voice recording.</p>${btn}</div>`;
  else if(s==="requesting")box.innerHTML=`<p style="color:var(--gold)">üîî Click <strong>"Allow"</strong> in the browser dialog.</p>`;
  else if(s==="granted")box.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><div class="green-dot"></div><p style="color:#86efac">Microphone granted ‚Äî voice recording ready.</p></div>`;
  else if(s==="denied")box.innerHTML=`<p style="color:#fca5a5;margin-bottom:8px">üö´ Microphone denied.</p><p style="color:rgba(245,240,232,0.4);font-size:13px">Click üîí in address bar ‚Üí Site settings ‚Üí Microphone ‚Üí Allow ‚Üí refresh.</p>`;
}
function setMicStatus(s){micStatus=s;renderMicBox("settingsMicBox");}
async function requestMic(){setMicStatus("requesting");try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});stream.getTracks().forEach(t=>t.stop());setMicStatus("granted");renderRecordings();}catch{setMicStatus("denied");}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GENERATE (via Netlify function ‚Äî API key stays server-side)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateAward() {
  const name=document.getElementById("studentName").value.trim();
  const combined=recordings.map(r=>recordings.length>1?`[${r.label}]\n${r.transcript.trim()}`:r.transcript.trim()).filter(t=>t.replace(/\[.*?\]\n?/,"").trim()).join("\n\n");
  if(!name||!combined){showDiscError("Please provide at least one transcript.");return;}
  showDiscError(""); if(activeRecId!==null)stopRecording();
  const s=currentStudent(); if(s){s.recordings=recordings.map(r=>({...r}));s.status="prog";s.class_id=currentClassId;await saveStudent(s);}
  document.getElementById("processingMsg").textContent=`Reviewing ${recordings.length>1?recordings.length+" recordings":"discussion"} for ${name}‚Ä¶`;
  genStep("processing");
  try {
    const res=await fetch("/.netlify/functions/generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        appPassword,
        payload:{model:"claude-sonnet-4-20250514",max_tokens:1000,system:SYSTEM_PROMPT,
          messages:[{role:"user",content:`Student Name: ${name}\n\nFaculty Discussion Transcripts:\n${combined}\n\nPlease propose an award title and write the award description for ${name}.`}]}
      }),
    });
    if(res.status===401){genStep("discussion");showDiscError("Incorrect app password. Please refresh and log in again.");return;}
    const bodyText=await res.text(); if(!bodyText.trim())throw new Error("Empty response from server.");
    const data=JSON.parse(bodyText);
    if(data.error)throw new Error("API error: "+(data.error.message||JSON.stringify(data.error)));
    const raw=(data.content||[]).map(c=>c.text||"").join("");
    const jsonMatch=raw.match(/\{[\s\S]*\}/); if(!jsonMatch)throw new Error("No JSON in response.");
    const parsed=JSON.parse(jsonMatch[0]);
    proposedTitle=parsed.title||"";
    document.getElementById("awardTitle").value=proposedTitle;
    document.getElementById("awardText").value=(parsed.text||"").trim();
    document.getElementById("restoreBtn").style.display="none";
    updateResultMeta(name,parsed.text||""); genStep("result");
  } catch(e) { genStep("discussion"); showDiscError("Failed to generate award text. ("+e.message+")"); }
}

function updateResultMeta(name,text){const wc=text.trim().split(/\s+/).filter(Boolean).length;const good=wc>=100&&wc<=150;document.getElementById("resultMeta").innerHTML=`${escHtml(name)} ¬∑ ${wc} words <span class="wc-badge ${good?"wc-good":"wc-bad"}">${good?"‚úì Ideal length":wc<100?"Too short":"Too long"}</span>`;}
function checkRestoreBtn(){const cur=document.getElementById("awardTitle").value;const show=proposedTitle&&cur!==proposedTitle;document.getElementById("restoreBtn").style.display=show?"":"none";document.getElementById("restoreBtn").textContent=`‚Ü© Restore AI suggestion: "${proposedTitle}"`;}
function restoreTitle(){document.getElementById("awardTitle").value=proposedTitle;document.getElementById("restoreBtn").style.display="none";}
function regenerate(){proposedTitle="";genStep("discussion");renderRecordings();}
document.addEventListener("input",e=>{if(e.target.id==="awardText")updateResultMeta(document.getElementById("studentName").value.trim(),e.target.value);if(e.target.id==="awardTitle")checkRestoreBtn();});

function copyAward(){const title=document.getElementById("awardTitle").value.trim();const text=document.getElementById("awardText").value.trim();navigator.clipboard.writeText(title?title+"\n\n"+text:text).then(()=>{const btn=document.getElementById("btnCopy");btn.textContent="‚úì Copied!";btn.style.background="linear-gradient(135deg,#22c55e,#16a34a)";btn.style.color="white";setTimeout(()=>{btn.textContent="Copy to Clipboard";btn.style.background="";btn.style.color="";},2500);});}

function showDiscError(msg){const el=document.getElementById("discError");el.style.display=msg?"":"none";el.textContent=msg;}
function escHtml(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async () => {
  // Check for stored session password
  const storedPw = sessionStorage.getItem("bcs_pw");
  if (storedPw) {
    appPassword = storedPw;
    await loadClasses();
    showView("classes");
  } else {
    showView("login");
  }
  if (micStatus !== "unsupported") {
    navigator.permissions && navigator.permissions.query({name:"microphone"}).then(p=>{
      if(p.state==="granted")micStatus="granted";
      else if(p.state==="denied")micStatus="denied";
      renderMicBox("settingsMicBox");
    }).catch(()=>{});
  }
})();
</script>
</body>
</html>
